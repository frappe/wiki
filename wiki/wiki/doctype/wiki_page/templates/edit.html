<span class="h2">{{ title }}</span>
<span class='btn btn-xs btn-primary submit-wiki-page pull-right'>Submit</div>

	<form class="mt-8" method="POST">
		<input class="d-none" type="text" name="csrf_token" value="{{ frappe.session.csrf_token }}">
		<input class="d-none" type="text" name="wiki_page" value="{{ doc.name }}">
		<input class="d-none" type="text" name="wiki_page_patch" value="{{ wiki_page_patch or ''}}">
		<input class="d-none" type="text" name="new" value="{{ frappe.form_dict.new or ''}}">
		<div class="form-group">
			<label class="sr-only" for="title_of_page">Title</label>
			<input class="form-control" type="text" name="title_of_page" value="{{ doc.title }}">
		</div>
		<div class="form-group">
			<label class="sr-only" for="content">Content</label>
			<ul class="nav nav-tabs" role="tablist">
				<li class="nav-item" role="presentation">
					<a {% if not wiki_page_patch %} class="nav-link active" {% else %} class="nav-link" {% endif %}
						id="write-tab" data-toggle="tab" href="#write" role="tab" aria-controls="write"
						aria-selected="true">Write</a>
				</li>
				<li class="nav-item" role="presentation">
					<a class="nav-link" id="preview-tab" data-toggle="tab" href="#preview" role="tab"
						aria-controls="preview" aria-selected="false">Preview</a>
				</li>
				{%- if not frappe.form_dict.new -%}

				<li class="nav-item" role="presentation">
					<a class="nav-link" id="diff-tab" data-toggle="tab" href="#diff" role="tab" aria-controls="diff"
						aria-selected="false">Compare</a>
				</li>
				{%- endif -%}
				<li class="nav-item" role="presentation">
					<a class="nav-link" id="attachment-tab" data-toggle="tab" href="#attachment" role="tab"
						aria-controls="attachment" aria-selected="false">Attachment</a>
				</li>
				{% if wiki_page_patch %}

				<li class="nav-item" role="presentation">
					<a {% if wiki_page_patch %} class="nav-link active" {% else %} class="nav-link" {% endif %}
						id="discussion-tab" data-toggle="tab" href="#discussion" role="tab" aria-controls="discussion"
						aria-selected="false">Discussion</a>
				</li>
				{% endif %}
			</ul>
			<div class="mt-4 tab-content">
				<div {% if not wiki_page_patch %} class="tab-pane fade show active" {% else %} class="tab-pane fade" {%
					endif %} id="write" role="tabpanel" aria-labelledby="write-tab">
					<div class="form-control wiki-content-md" hidden>{{ content_md }}</div>
					<div class="form-control wiki-content-html" hidden>{{ content_html }}</div>
					<div class="wiki-write"></div>
				</div>
				<div class="tab-pane fade" id="preview" role="tabpanel" aria-labelledby="preview-tab">
					<div class="from-markdown wiki-preview"></div>
				</div>

				{%- if not frappe.form_dict.new -%}
				<div class="tab-pane fade" id="diff" role="tabpanel" aria-labelledby="preview-tab">
					<div class="from-markdown wiki-diff"></div>
				</div>
				{%- endif -%}

				<div class="tab-pane fade" id="attachment" role="tabpanel" aria-labelledby="attachment-tab">
					<div class="wiki-attachment"></div>
					<br>
					<span class='btn add-attachment-wiki'>Upload Attachment</span>
				</div>

				{% if wiki_page_patch %}

				<div {% if wiki_page_patch %} class="tab-pane fade show active" {% else %} class="tab-pane fade" {%
					endif %} id="discussion" role="tabpanel" aria-labelledby="discussion-tab">

					{% include "wiki/doctype/wiki_page/templates/comment.html" %}



				</div>
				{% endif %}
			</div>

		</div>


		</div>
	</form>



	{% block base_scripts %}
	<!-- js should be loaded in body! -->
	<script type="text/javascript" src="/assets/frappe/js/lib/jquery/jquery.min.js"></script>
	<script src="https://unpkg.com/turndown/dist/turndown.js"></script>
	{{ include_script('libs.bundle.js') }}

	{{ include_script('frappe-web.bundle.js') }}
	{{ include_script('controls.bundle.js') }}
	{{ include_script('dialog.bundle.js') }}
	{{ include_script('bootstrap-4-web.bundle.js') }}
	<script type="text/javascript" src="/assets/frappe/node_modules/moment/min/moment-with-locales.min.js"></script>
	<script type="text/javascript"
		src="/assets/frappe/node_modules/moment-timezone/builds/moment-timezone-with-data.min.js"></script>
	{{ include_script('desk.bundle.js') }}
	{{ include_script('wiki.bundle.js') }}


	<script type="text/javascript" src="/assets/frappe/node_modules/vue/dist/vue.js"></script>

	<script>
		Vue.prototype.__ = window.__;
		Vue.prototype.frappe = window.frappe;
		var edit = new EditAsset();
	</script>


	<script>
		$('document').ready(()=>{

			$('.sidebar-item a').each(function (index) {
				const active_class = 'active'
				const non_active_class = ''
				let page_href = window.location.href;
				if (page_href.indexOf('#') !== -1) {
					page_href = page_href.slice(0, page_href.indexOf('#'));
				}
	
				if (page_href.includes(this.href.trim() ) ) {
					$(this).removeClass(non_active_class).addClass(active_class);
					$($($($(this).context.parentElement).context.parentElement).context.parentElement).addClass(active_class);
				} else {
					$($($($(this).context.parentElement).context.parentElement).context.parentElement).removeClass(active_class).addClass(non_active_class);
				}
			});

			set_active_sidebar()
			set_search_bar()
			set_togglers()
			set_empty_ul()
			set_sortable()
			set_up_boot()
			set_add_item()
		});


		function toggle_sidebar(event) {
			$(event.currentTarget).parent().find('ul').toggleClass('hidden')
			$(event.currentTarget).find('.drop-icon').toggleClass('hidden')
			$(event.currentTarget).find('.drop-left').toggleClass('hidden')
			event.stopPropagation()
		 }
	
		 function set_active_sidebar() {
	
	
				$('.doc-sidebar,.web-sidebar').on('click', '.collapsible', toggle_sidebar)
				$('.sidebar-group').children('ul').addClass('hidden')
				$('.sidebar-item.active').parents(' .web-sidebar .sidebar-group>ul').removeClass('hidden')
				const sidebar_groups = $('.sidebar-item.active').parents('.web-sidebar .sidebar-group')
				sidebar_groups.each(function()  {$(this).children('.collapsible').find('.drop-left').addClass('hidden')})
				sidebar_groups.each(function()  {$(this).children('.collapsible').find('.drop-icon').removeClass('hidden')})
		

		 }
	
	
	
		 function set_search_bar() {
			$(`<li class="nav-item">
				<div class="website-search doc-search" id="search-container"></div>
			</li>`).insertAfter('.nav-item:nth-child(2)');
			frappe.setup_search('#search-container', '{{ docs_search_scope or "" }}');

		 }
	
	
		 function set_togglers() {
			let language_switcher = $('nav').find(".nav-item")
			let current_location = window.location.href;
			let language_pattern = 'en|es|de';
			let match = current_location.match('en|es|de')
		
			if (match) {
				$(language_switcher[0]).find('a')[0].innerText = match[0]
			}
		
			$('.dropdown-menu:first').find('.dropdown-item').click((event) => {
				current_location = window.location.href;
				let target_location = current_location.replace(/en|es|de/, event.target.innerText)
				$(event.target).attr('href', target_location)
			});
		
			let version_switcher = $('nav').find(".nav-item")
			current_location = window.location.href;
			let version_pattern = 'v12|v13';
			match = current_location.match('v12|v13')
		
			if (match) {
				$(version_switcher[1]).find('a')[0].innerText = match[0]
			}
		
			$($('ul.dropdown-menu').get(1)).find('.dropdown-item').click((event) => {
				current_location = window.location.href;
				target_location = current_location.replace(/v12|v13/, event.target.innerText)
				$(event.target).attr('href', target_location)
			});
		 }

	
		 function set_empty_ul(){
		$('.collapsible').each( function() {
			if ($(this).parent().find('ul').length == 0 ) {
				$(this).parent().append($(`<ul class="list-unstyled hidden" style="min-height:20px;"> </ul`))
			}
		} )
	}

	function set_sortable() {
		$('.web-sidebar ul').each( function() {
			new Sortable(this, {  group: {
				name: 'qux',
				put: ['qux'], pull: ['qux']
				},
			});
		});
	}

	function set_up_boot() {
		frappe.boot = {{ boot }};
	}

	function set_add_item(){

		$(`<div class="text-muted add-sidebar-item">+ Add Item</div>`).appendTo($('.web-sidebar'))



		$(".add-sidebar-item").click(function () {

			var dfs = [
				{
					fieldname: "type",
					label: "Add Type",
					fieldtype: "Autocomplete",
					options: ['Add Wiki Page', 'New Wiki Sidebar'],

				},
				{
					fieldname: "wiki_page",
					label: "Wiki Page",
					fieldtype: "Link",
					options: 'Wiki Page',
					depends_on:"eval: doc.type=='Add Wiki Page'",
					mandatory_depends_on:"eval: doc.type=='Add Wiki Page'",
				},
				{
					fieldname: "route",
					label: "Route",
					fieldtype: "Data",
					depends_on:"eval: doc.type=='New Wiki Sidebar'",
					mandatory_depends_on:"eval: doc.type=='New Wiki Sidebar'",
				},
				{
					fieldname: "title",
					label: "Title",
					fieldtype: "Data",
					depends_on:"eval: doc.type=='New Wiki Sidebar'",
					mandatory_depends_on:"eval: doc.type=='New Wiki Sidebar'",
				}
			];

			var dialog = new frappe.ui.Dialog({
				fields: dfs,
				primary_action: function (fields) {
					console.log(fields)
					if (fields.type=='Add Wiki Page') {
						frappe.call({
							method: "frappe.client.get_value",
							args: {
							  doctype:'Wiki Page',
							  fieldname: 'title',
							  filters: fields.wiki_page
							},
							callback: function(r) {
								let $new_page = $(`
								<li class="sidebar-item" data-type="Wiki Page" data-name="${fields.wiki_page}" data-new=1 ><div>
									<div style="align-items: center;">
										<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-dot" viewBox="0 0 16 16">
											<path d="M8 9.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z"></path>
										</svg>
									</div>
									<div>
										<a href="#" class="green" >
											${r.message.title}
										</a>
									</div></div>
									</li>
								`)
							
								$new_page.insertAfter($('.doc-sidebar').find('a.active').closest('.sidebar-item'))
							}
						  });
					} else {
						
						let $new_page = $(`
						<li class="sidebar-group" data-type="Wiki Sidebar" data-name="${fields.route}" data-new=1 data-title="${fields.title}" draggable="false">
							<div class="collapsible">
							<span class="drop-icon hidden">
								<!-- <svg class="icon icon-xs">
									<use href="#icon-small-down"></use>
								</svg> -->
								<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
									<path d="M8 10L12 14L16 10" stroke="#4C5A67" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"></path>
									</svg>
							</span>
							<span class="drop-left">
								<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
									<path d="M10 16L14 12L10 8" stroke="#4C5A67" stroke-linecap="round" stroke-linejoin="round"></path>
									</svg>
							</span>
							<span class="h6">${fields.title}</span>
					
							</div>
							<ul class="list-unstyled hidden" style="min-height:20px;"> </ul
						</li>
						`)
					
						$new_page.appendTo($('.doc-sidebar .sidebar-items').children('.list-unstyled').not('.hidden'))

						

						$('.web-sidebar ul').each( function() {
							new Sortable(this, {  group: {
								name: 'qux',
								put: ['qux'], pull: ['qux']
								},
							});
						});

					}
					dialog.hide()
					
				}
			});
			dialog.show();
		});
	}
	</script>

	{%- if  frappe.form_dict.new -%}

		<script>
			let $new_page = $(`
				<li class="sidebar-item" data-type="Wiki Page" data-name="new" data-new=1><div>
					<div style="align-items: center;">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-dot" viewBox="0 0 16 16">
							<path d="M8 9.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z"></path>
						</svg>
					</div>
					<div>
						<a href="#" class="green" >
							New Wiki Page
						</a>
					</div></div>
				</li>
			`)
			
			$new_page.insertAfter($('.doc-sidebar').find('a.active').closest('.sidebar-item'))


		</script>
	{%- endif -%}

	{% endblock %}