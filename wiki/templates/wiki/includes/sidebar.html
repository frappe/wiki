{% from "templates/wiki/macros/sidebar_tree.html" import render_wiki_tree %}

<div class="wiki-sidebar w-72 bg-gray-50 border-r border-gray-200 h-screen overflow-y-auto" 
     x-data="wikiSidebar()">
    <div class="p-4 border-b border-gray-200 bg-white">
        <div>
            <img class="size-8" src="{{ wiki_space.light_mode_logo }}"/>
            <h3 class="text-lg font-semibold text-gray-700">{{ wiki_space.space_name or _("Wiki") }}</h3>
        </div>
    </div>
    <nav class="py-2">
        {{ render_wiki_tree(nested_tree, current_route=doc.route if doc else '') }}
    </nav>
</div>

<script>
    function wikiSidebar() {
        return {
            // Store expanded states with persistence
            expandedStates: Alpine.$persist({}),
            currentRoute: '{{ doc.route if doc else "" }}',
            
            init() {
                // Auto-expand parents of current page
                this.expandCurrentPageParents();
                
                // Debug: log all route elements
                this.$nextTick(() => {
                    const allRouteElements = document.querySelectorAll('[data-route]');
                });
            },
            
            toggleNode(nodeId) {
                // Toggle the expanded state for this node
                this.expandedStates[nodeId] = !this.expandedStates[nodeId];
            },
            
            isExpanded(nodeId) {
                // Return whether this node is expanded (default to false)
                return this.expandedStates[nodeId] || false;
            },
            
            expandCurrentPageParents() {
                // Find and expand all parent groups of the current page
                if (!this.currentRoute) return;
                
                // Wait for DOM to be fully rendered
                this.$nextTick(() => {
                    // Find the current page element
                    const currentPageElement = document.querySelector(`[data-route="${this.currentRoute}"]`);
                    if (!currentPageElement) return;
                    
                    // Find all parent group containers and expand them
                    let parentElement = currentPageElement.parentElement;
                    while (parentElement) {
                        // Look for parent wiki-children containers
                        if (parentElement.classList.contains('wiki-children')) {
                            // Find the sibling wiki-item-content that has a data-node-id
                            const parentItem = parentElement.parentElement;
                            if (parentItem) {
                                const parentContent = parentItem.querySelector('.wiki-item-content[data-node-id]');
                                if (parentContent) {
                                    const nodeId = parentContent.getAttribute('data-node-id');
                                    if (nodeId) {
                                        this.expandedStates[nodeId] = true;
                                    }
                                }
                            }
                        }
                        parentElement = parentElement.parentElement;
                    }
                });
            }
        }
    }
</script>
